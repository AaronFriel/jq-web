<!doctype html>

<script>
var stdin = ''
var stdout = ''
var stderr = ''

var Module = {
  noInitialRun: true,
  noExitRuntime: true,
  preRun: function () {
    FS.init(
      function input () {
        if (stdin) {
          var c = stdin[0]
          stdin = stdin.slice(1)
          return c.charCodeAt(0)
        } else return null
      },
      function output (c) {
        if (c) stdout += String.fromCharCode(c)
        else stdout += '\n'
      },
      function error (c) {
        if (c) stderr += String.fromCharCode(c)
        else stderr += '\n'
      }
    )
  }
}
</script>
<script src=jq.js></script>
<script>
function exit () {}

function jqfilter (json, filter) {
  stdin = JSON.stringify(json)
  stdout = ''
  stderr = ''

  Module.callMain(['-c', filter])

  // calling main closes stdout, so we reopen it here:
  FS.streams[1] = FS.open('/dev/stdout', 577, 0)

  stdout = stdout.trim()
  try {
    if (stdout.indexOf('\n') !== -1) {
      return stdout
        .split('\n')
        .filter(x => x)
        .reduce((acc, line) => acc.concat(JSON.parse(line)), [])
    } else {
      return JSON.parse(stdout)
    }
  } catch (e) {}

  if (stdout) {
    return stdout
  }

  throw new Error(stderr)
}
</script>
